---
title: "Main analysis"
author: "me medesimo"
date: "2025-08-20"
output: html_document
---

```{r setup}
source("bnn.R")
source("gigi_puzza.R")
source("fairness.R")
source("uncertainties.R")
source("data/syntethic_datasets/01_synthetic_data.R")
```

```{r}
# Prepara train/test split
set.seed(42)
train_indices <- sample(nrow(sd1_data), 0.8 * nrow(sd1_data))
train_data <- sd1_data[train_indices, ]
test_data <- sd1_data[-train_indices, ]
```


```{r}
train_data <- train_data %>% rename(y = Y) # rinominato y piccolo perche pacchetto stan richiede cosi
train_data$y <- as.numeric(train_data$y)
test_data <- test_data %>% rename(y = Y) # rinominato y piccolo perche pacchetto stan
test_data$y <- as.numeric(test_data$y)

# train_data$y <- ifelse(train_data$y == 1, 0, 1) # Conversozione da 1 2 a 0 1 perche libreria prende cosi

uncertainty_bnn <- create_uncertainty_bnn(train_data, 'y')
```

```{r}
# Opzione 2: Calcolo completo con ensemble
accuracy_results <- calculate_ensemble_accuracy(uncertainty_bnn, test_data, 'y')
```

```{r}

test_data$pred <- rowMeans(predict(uncertainty_bnn))
results <- calculate_metrics_by_group_2(test_data, group_col = "G", true_col = "y", pred_col = "pred", threshold = 1.5)
print(results)

ensemble_pred <- rowMeans(predict(uncertainty_bnn, newdata = test_data))
final_pred <- ifelse(ensemble_pred > 1.5, 2, 1)

predict(uncertainty_bnn, newdata = test_data)

results <- calculate_ensemble_metrics_by_group(
  models = uncertainty_bnn,
  test_data = test_data,
  target_col = "y",
  group_col = "G", 
  levels_order = c("0", "1"),
  positive_class = 2
)

# Access results
results$ensemble_metrics_by_group  # TPR, FPR, etc. by group
results$fairness_measures          # All fairness ratios
results$confusion_matrices         # TP, TN, FP, FN counts
```

```{r}
uncertainties <- calculate_uncertainties(uncertainty_bnn, test_data)
fairness_measures <- calculate_uncertainty_fairness(uncertainties, test_data$G)
print(fairness_measures)
```
# Aggiungi un flag per distinguere i dati
train_data$is_test <- FALSE
test_data$is_test <- TRUE

# Unisci i dati
full_data <- rbind(train_data, test_data)

# Allena il modello su full_data
model <- bnns(
  formula = as.formula(paste("Y", "~ .")),
  data = full_data[, names(full_data) != "is_test"],
  hidden_layers = NULL,
  epochs = 5,
  prior_pi = 0.5,
  prior_sigma1 = 0,
  prior_sigma2 = 6,
  lambda = 2000,
  init_mu = 0,
  init_sigma = 1,
  early_stopping = TRUE,
  verbose = TRUE
)

# Predizione su tutto il dataset
pred_matrix <- predict(model)

# Calcola la media dei campioni Monte Carlo
full_data$pred <- rowMeans(pred_matrix)

# Estrai solo le predizioni sui dati di test
test_preds <- full_data[full_data$is_test, ]

# Calcola l'accuracy
test_preds$pred_bin <- ifelse(test_preds$pred >= 0.5, 1, 0)
test_preds$true_bin <- ifelse(test_preds[["Y"]] >= 0.5, 1, 0)

accuracy <- mean(test_preds$pred_bin == test_preds$true_bin)
print(paste("Accuracy sui dati di test:", round(accuracy, 4)))



