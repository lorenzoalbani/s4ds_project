---
title: "Test Accuracy BNN su Dataset Sintetico"
output: html_document
---

```{r setup, include=FALSE}
library(reticulate)
conda_create("r-tf-env")


knitr::opts_chunk$set(echo = TRUE)
library(keras)
install_keras()
library(tensorflow)
tf_config()
```

### 📦 Caricamento del dataset

```{r load-data}
source("data/syntethic_datasets/01_synthetic_data.R")

# Supponiamo che il dataset si chiami `synthetic_data`
str(sd1_data)
```

### 🧠 Caricamento del modello BNN

```{r load-model}
source("Bnn.R")

# Prepara i dati
x <- as.matrix(sd1_data[, !(names(sd1_data) %in% c("Y"))])
x <- data.frame(lapply(x, function(col) as.numeric(as.character(col))))
y <- as.numeric(sd1_data$Y)

# Normalizza se necessario
x <- scale(x)

# Suddividi in training e test
set.seed(123)
train_idx <- sample(1:nrow(x), size = 0.8 * nrow(x))
x_train <- x[train_idx, ]
y_train <- y[train_idx]
x_test <- x[-train_idx, ]
y_test <- y[-train_idx]

# Costruisci e allena il modello
model <- build_bnn_model(input_shape = ncol(x_train))
model %>% fit(x_train, y_train, epochs = 20, batch_size = 32, verbose = 0)
```

### 🔍 Predizione con Monte Carlo Dropout

```{r predict-uncertainty}
results <- predict_with_uncertainty(model, x_test, n_samples = 50)

# Accuracy
pred_labels <- ifelse(results$mean > 0.5, 1, 0)
accuracy <- mean(pred_labels == y_test)
cat("Accuracy complessiva:", round(accuracy, 3), "
")
```

### 📊 Analisi per gruppi

```{r group-analysis}
# Supponiamo che synthetic_data abbia una colonna "G" per il gruppo (0 = minoranza, 1 = maggioranza)
group_test <- synthetic_data[-train_idx, "G"]

df_results <- data.frame(
  group = group_test,
  pred = results$mean,
  epistemic = results$epistemic,
  aleatoric = results$aleatoric,
  true = y_test
)

# Accuracy per gruppo
group_acc <- aggregate(df_results$true == (df_results$pred > 0.5), by = list(Group = df_results$group), FUN = mean)
print(group_acc)

# Incertezza media per gruppo
group_epistemic <- aggregate(df_results$epistemic, by = list(Group = df_results$group), FUN = mean)
group_aleatoric <- aggregate(df_results$aleatoric, by = list(Group = df_results$group), FUN = mean)

print(group_epistemic)
print(group_aleatoric)
```
