---
title: "Ensemble + Formule Uncertainty"
author: "me medesimo"
date: "2025-08-19"
output: html_document
---

# Setup
```{r setup}
library(randomForest)
library(dplyr)

```

```{r}
# Funzione per creare ensemble che simula Monte Carlo sampling
create_uncertainty_ensemble <- function(data, n_models = 10) {
  models <- list()
  
  for(i in 1:n_models) {
    # Bootstrap sampling (per aleatoric)
    boot_indices <- sample(nrow(data), nrow(data), replace = TRUE)
    boot_data <- data[boot_indices, ]
    
    # Aggiungi noise ai parametri (per epistemic) 
    set.seed(i)  # diversi seed per diversi modelli
    
    # Allena modello (esempio con randomForest)
    model <- randomForest(target ~ ., data = boot_data, 
                          mtry = sample(2:ncol(data)-1, 1),  # varia parametri
                          ntree = sample(100:500, 1))
    models[[i]] <- model
  }
  return(models)
}
```


```{r}
# Calcola uncertainties seguendo Eq. 7 del paper
calculate_uncertainties <- function(ensemble_models, test_data) {
  M <- length(ensemble_models)
  n_samples <- nrow(test_data)
  
  # Matrice delle predizioni: ogni riga = sample, ogni colonna = modello
  P_matrix <- matrix(0, nrow = n_samples, ncol = M)
  
  # Ottieni predizioni probabilistiche da ogni modello
  for(m in 1:M) {
    # Per classificazione binaria, prendi prob classe positiva
    preds <- predict(ensemble_models[[m]], test_data, type = "prob")[,2]
    P_matrix[,m] <- preds
  }
  
  # Calcola P̄ (media delle predizioni)
  P_bar <- rowMeans(P_matrix)
  
  # EPISTEMIC UNCERTAINTY (Eq. 7 prima parte)
  epistemic <- numeric(n_samples)
  for(i in 1:n_samples) {
    diff <- P_matrix[i,] - P_bar[i]
    epistemic[i] <- mean(diff^2)  # (P_m - P̄)^T * (P_m - P̄)
  }
  
  # ALEATORIC UNCERTAINTY (Eq. 7 seconda parte)  
  aleatoric <- numeric(n_samples)
  for(i in 1:n_samples) {
    for(m in 1:M) {
      p_m <- P_matrix[i,m]
      # diag(P_m) - P_m^T * P_m per classificazione binaria
      aleatoric[i] <- aleatoric[i] + (p_m - p_m^2)
    }
    aleatoric[i] <- aleatoric[i] / M
  }
  
  # PREDICTIVE UNCERTAINTY = Epistemic + Aleatoric
  predictive <- epistemic + aleatoric
  
  return(list(
    epistemic = epistemic,
    aleatoric = aleatoric, 
    predictive = predictive
  ))
}
```

```{r}
# Fairness measures dal paper
calculate_fairness_measures <- function(uncertainties, sensitive_attr) {
  groups <- unique(sensitive_attr)
  G0 <- groups[1]  # minority group
  G1 <- groups[2]  # majority group
  
  # Group-level uncertainties (media per gruppo)
  U_G0 <- mean(uncertainties[sensitive_attr == G0])
  U_G1 <- mean(uncertainties[sensitive_attr == G1])
  
  # Fairness measure F_u = U(G=0) / U(G=1) - Eq. 27
  fairness_ratio <- U_G0 / U_G1
  
  return(list(
    U_G0 = U_G0,
    U_G1 = U_G1,
    fairness_ratio = fairness_ratio,
    is_fair = abs(fairness_ratio - 1) <= 0.2  # threshold dal paper
  ))
}
```